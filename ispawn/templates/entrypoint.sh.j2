#!/bin/bash
set -e

apt-get update

apt-get upgrade -y --no-install-recommends ca-certificates adduser

# Setup logging
export LOG_DIR=/var/log/ispawn
mkdir -p $LOG_DIR
echo "[$(date)] Starting container initialization..." > "${LOG_DIR}/entrypoint.log"
exec 1> >(tee -a "${LOG_DIR}/entrypoint.log")
exec 2>&1

{{ entrypoint_chunk|safe }}

# Create user if it doesn't exist
if ! getent passwd "$USER_NAME" &>/dev/null; then
    echo "[$(date)] Creating user $USER_NAME..."
    useradd -m -s /bin/bash -u $USER_UID "$USER_NAME"
    echo "$USER_NAME:$USER_PASS" | chpasswd
    adduser "$USER_NAME" sudo
    echo "[$(date)] User $USER_NAME created successfully"
fi

echo "$USER_NAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

mkdir -p /var/log/ispawn/services
chown -R $USER_NAME:$USER_NAME /var/log/ispawn/services
{% for service in services %}
echo "[$(date)] Starting {{ service }} service..."
echo "" > /var/log/ispawn/services/{{ service }}.log
chown $USER_NAME:$USER_NAME /var/log/ispawn/services/{{ service }}.log
bash /usr/local/bin/ispawn-entrypoint-{{ service }}.sh
echo "[$(date)] {{ service }} initiated."
{% endfor %}

sleep infinity
